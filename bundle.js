(()=>{"use strict";let e=!1,t=null,n=null;function s(){t=n.checked,localStorage.setItem("ignoreDirtyState",t.toString())}function r(t){e=t}var l=[];function o(){return l}function a(e){l=e}function i(){localStorage.setItem("lastUpdate",(new Date).getTime().toString()),r(!0),localStorage.setItem("items",JSON.stringify(l)),window.dispatchEvent(new Event("updateAll"))}const d={Tank:"#b43c4a",DPS:"#59c8ff",Support:"#6ad330",Open:"#b83cff"},c=["Tank","DPS","Support","Open"];function u(e,t){return function(n,s){return n[t]<s[t]?"ASC"===e?-1:1:n[t]>s[t]?"ASC"===e?1:-1:0}}function p(e,t,n){return e.reduce(((e,n)=>n[t]>e?n[t]:e),n)}function m(e,t,n){const s=e.reduce(((e,n)=>n[t]<e&&n[t]>0?n[t]:e),n);return s!==n?s:null}function w(e,t,n,s){const r=e.findIndex((e=>e[n]===s));if(r>-1)return e[r][t]}function f(e,t,n){return e.reduce(((e,s)=>e>n?e:s[t]),0)||n}function g(e,t){return t.reduce(((t,[n,s,r])=>t?null===s?e[n]!=r:e[n]==s:t),!0)}function h(e,t){return e.reduce(((e,n)=>(g(n,t)&&(e+=1),e)),0)}function y(e,t,n){const s=function(e,t,n){return e.reduce(((e,s)=>(g(s,n)&&(e.sum+=s[t],e.count+=1),e)),{sum:0,count:0})}(e,t,n);return s.sum/s.count}function E(e,t,n){return e.reduce(((e,s)=>(s[t]==n?e[0]+=1:e[0]=0,e[0]>e[1]&&(e[1]=e[0]),e)),[0,0])[1]||0}function S(e,t="All"){const n=o().map(((e,t)=>{const n=(s=e,JSON.parse(JSON.stringify(s)));var s;return n.sortId=t,n.session=parseInt(e.session),n.sr=parseInt(e.sr),n.size=parseInt(e.size),n.season=parseInt(e.season),n})).filter((t=>null===e||t.role===e)).filter((e=>"All"===t||e.season==t));return n.forEach(((e,t)=>{const s=n[t-1],r=s&&s.sr||0;"default"==e.wld?(e.wasDefault=!0,e.sr>r?e.wld="Win":e.sr<r?e.wld="Loss":e.wld="Draw",e.diff=e.sr-r):e.diff=0})),n}function b(e,t="All"){const n=S(e,t),s=n[n.length-1]||{sr:0},r=p(S(null),"session",0),l=(o=[["session",r]],n.reduce(((e,t)=>(g(t,o)&&e.push(t),e)),[]));var o;const a={enhancedEntries:n,gamesPlayed:n.length,startSr:f(n,"sr",0),high:p(n,"sr",0),low:m(n,"sr",5e3)||0,win:h(n,[["wld","Win"],["wld","Win"]]),loss:h(n,[["wld","Loss"]]),draw:h(n,[["wld","Draw"]]),winStreak:E(n,"wld","Win"),lossStreak:E(n,"wld","Loss"),currentSr:s.sr,srGain:null,winRate:null,srWin:y(n,"diff",[["wld","Win"],["diff",null,0]]),srLoss:y(n,"diff",[["wld","Loss"],["diff",null,0]]),srAvg:y(n,"diff",[["wasDefault",!0],["diff",null,0]]),gamesPlayedGroup:{1:h(n,[["size",1]]),2:h(n,[["size",2]]),3:h(n,[["size",3]]),4:h(n,[["size",4]]),5:h(n,[["size",5]]),6:h(n,[["size",6]])},winGroup:{1:h(n,[["size",1],["wld","Win"]]),2:h(n,[["size",2],["wld","Win"]]),3:h(n,[["size",3],["wld","Win"]]),4:h(n,[["size",4],["wld","Win"]]),5:h(n,[["size",5],["wld","Win"]]),6:h(n,[["size",6],["wld","Win"]])},lossGroup:{1:h(n,[["size",1],["wld","Loss"]]),2:h(n,[["size",2],["wld","Loss"]]),3:h(n,[["size",3],["wld","Loss"]]),4:h(n,[["size",4],["wld","Loss"]]),5:h(n,[["size",5],["wld","Loss"]]),6:h(n,[["size",6],["wld","Loss"]])},drawGroup:{1:h(n,[["size",1],["wld","Draw"]]),2:h(n,[["size",2],["wld","Draw"]]),3:h(n,[["size",3],["wld","Draw"]]),4:h(n,[["size",4],["wld","Draw"]]),5:h(n,[["size",5],["wld","Draw"]]),6:h(n,[["size",6],["wld","Draw"]])},winRateGroup:{1:null,2:null,3:null,4:null,5:null,6:null},sessionStart:w(n,"sr","id",f(l,"id",0)-1)||0,sessionCurrent:(i=l,d="sr",c=0,i.reduce(((e,t)=>t[d]>c?t[d]:e),0)||c),sessionWin:h(l,[["wld","Win"]]),sessionLoss:h(l,[["wld","Loss"]]),sessionDraw:h(l,[["wld","Draw"]])};var i,d,c;return a.srGain=a.currentSr-a.startSr,a.winRate=a.win/(a.gamesPlayed-a.draw),a.winRateGroup={1:a.winGroup[1]/(a.gamesPlayedGroup[1]-a.drawGroup[1])||0,2:a.winGroup[2]/(a.gamesPlayedGroup[2]-a.drawGroup[2])||0,3:a.winGroup[3]/(a.gamesPlayedGroup[3]-a.drawGroup[3])||0,4:a.winGroup[4]/(a.gamesPlayedGroup[4]-a.drawGroup[4])||0,5:a.winGroup[5]/(a.gamesPlayedGroup[5]-a.drawGroup[5])||0,6:a.winGroup[6]/(a.gamesPlayedGroup[6]-a.drawGroup[6])||0},a}function x(){return p(S(null),"season",0)}function L(){return c.reduce(((e,t)=>[...e,...S(t)]),[]).sort(((e,t)=>e.sortId>t.sortId?1:t.sortId>e.sortId?-1:0))}function v(e){return Chart.defaults.global.defaultFontColor=getComputedStyle(document.body).getPropertyValue("--color"),C&&C.update(),A&&A.update(),I&&I.update(),G&&G.update(),!1}window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",v);var C=null,A=null,I=null,G=null;function z(){const e=document.querySelector("select.season").value,t=c.reduce(((t,n)=>(t[n]=b(n,e),t)),{});let n=A.data.datasets;c.forEach(((e,s)=>{const r=n[s],l=t[e];r.data[0]=l.gamesPlayed?100*l.winRate-50:0;for(let e=1;e<6;e++)r.data[e]=l.gamesPlayedGroup[e]?100*l.winRateGroup[e]-50:0})),A.update(),n=C.data.datasets,c.forEach(((e,s)=>{const r=n[s],l=t[e];r.data[0]=l.gamesPlayed;for(let e=1;e<6;e++)r.data[e]=l.gamesPlayedGroup[e]})),C.update(),n=I.data.datasets,c.forEach(((e,s)=>{const r=n[s],l=t[e].enhancedEntries.filter((e=>e.sr>0)).sort(u("DESC","sortId")).reduce(((e,t)=>(0===e.maxLength||(e.items.push(t),e.maxLength-=1),e)),{items:[],maxLength:20}).items.sort(u("ASC","sortId"));for(let e=0;e<20;e++)r.data[e]=l[e]&&l[e].sr||null})),I.update(),n=G.data.datasets,c.forEach(((e,s)=>{let r=new Array(100).fill(0);const l=t[e].enhancedEntries.filter((e=>e.sr>0)).map((e=>e.sr));let o=l.length/r.length;if(o>1){const e=Math.round(o);r=r.map(((t,n)=>{let s=0;for(let t=0;t<e;t++){const e=Math.round(n*o+t);s+=l[e]}return Math.round(s/e)}))}else o<1&&(r=r.map(((e,t)=>{const n=Math.floor(t*o);return l[n]})));const a=n[s];for(let e=0;e<100;e++)a.data[e]=r[e]||null})),G.update()}function W(){const e=document.getElementById("stats"),t=e.querySelector("div.table");t.innerHTML="";const n=e.querySelector("select.role").value,s=L().filter((e=>"All"==n||e.role==n)),r=s.length<10?s.length:10;s.splice(s.length-r,r).forEach((e=>{let n=document.createElement("p");t.appendChild(n);const s=document.createElement("span");n.appendChild(s);const r=document.createElement("span");n.appendChild(r),r.style.width="20px",r.style.height="20px",r.style.display="inline-block",r.style.backgroundColor="rgb(70, 130, 180)",r.style.marginLeft="5px",r.style.position="relative",r.style.top="5px",r.style.backgroundColor=d[e.role],s.innerText=e.diff.toFixed(0),s.style.display="inline-block",s.style.textAlign="right";const l=document.createElement("span");n.appendChild(l),l.innerText=e.role,l.style.display="inline-block",l.style.marginLeft="5px"}))}function D(){const e=document.querySelector("#entries tbody"),t=o();e.querySelectorAll("tr").forEach((e=>{const n=e.dataset.itemId,s=t.findIndex((e=>e.id===parseInt(n))),r=t[s],l=t.filter((e=>e.role===r.role&&e.id<r.id)).slice(-1);let o="*";if(1===l.length){const e=l[0].sr,t=r.sr;o=t>e?"W":t<e?"L":"D"}e.querySelector(".wld").textContent=`${o}`}))}function k(){let e=o();document.querySelector("#entries tbody").innerHTML="",e?e.forEach((e=>{P(e)})):P(),window.dispatchEvent(new Event("updateAll"))}function P(e){const t=o();if(!e){const n=t[t.length-1]||{};let s=n.session||"1";const r=new Date(parseInt(localStorage.getItem("lastUpdate"),0)||0).getTime();(new Date).getTime()-r>432e5&&(s=parseInt(s,10)+1),e={id:n.id+1||1,session:s.toString(),sr:n.sr||"2000",role:n.role||"Support",size:n.size||"2",season:n.season||"26",wld:"default"},t.push(e),i()}const n=document.querySelector("#entries tbody"),s=document.createElement("tr");n.appendChild(s),s.dataset.itemId=e.id;const r=document.createElement("td");s.appendChild(r),r.classList.add("session");const l=document.createElement("input");r.appendChild(l),l.setAttribute("type","text"),l.value=e.session,l.addEventListener("change",T);const a=document.createElement("td");s.appendChild(a),a.classList.add("sr");const d=document.createElement("input");a.appendChild(d),d.setAttribute("type","text"),d.value=e.sr,d.addEventListener("change",T);const u=document.createElement("td");s.appendChild(u),u.classList.add("role");const p=document.createElement("select");u.appendChild(p),c.forEach((e=>{const t=document.createElement("option");p.appendChild(t),t.innerText=e,t.setAttribute("value",e)})),p.value=e.role,p.addEventListener("change",T);const m=document.createElement("td");s.appendChild(m),m.classList.add("wld"),m.textContent="...";const w=document.createElement("td");s.appendChild(w),w.classList.add("size");const f=document.createElement("input");w.appendChild(f),f.setAttribute("type","text"),f.value=e.size,f.addEventListener("change",T);const g=document.createElement("td");s.appendChild(g),g.classList.add("season");const h=document.createElement("input");g.appendChild(h),h.setAttribute("type","text"),h.value=e.season,h.addEventListener("change",T);const y=document.createElement("td");s.appendChild(y);const E=document.createElement("button");y.appendChild(E),E.innerText="X",E.addEventListener("click",q),n.closest("div").scrollTop=n.closest("div").scrollHeight,D()}function T(e){const t=o(),n=e.target.closest("tr"),s=n.dataset.itemId,r=t.findIndex((e=>e.id==s)),l=t[r];l.session=n.querySelector(".session input").value,l.sr=n.querySelector(".sr input").value,l.role=n.querySelector(".role select").value,l.size=n.querySelector(".size input").value,l.season=n.querySelector(".season input").value,l.wld="default",i()}function q(e){const t=e.target.closest("tr"),n=t.dataset.itemId;a(o().reduce(((e,t)=>(t.id!=n&&e.push(t),e)),[])),t.parentElement.removeChild(t),i()}let R;function B(e){const t=e.target.files[0];if(t){const e=new FileReader;e.onload=function(){try{a(JSON.parse(e.result)),k(),r(!1)}catch(e){console.log(e)}},e.readAsText(t)}}window.addEventListener("load",(()=>{R=function(){const e=document.createElement("input");return e.setAttribute("id","FileHandler"),e.setAttribute("type","file"),e.setAttribute("accept",".txt"),e.setAttribute("multiple","false"),document.getElementById("hidden").appendChild(e),e.onchange=B.bind(this),e}()})),window.addEventListener("load",(()=>{var e;e=document.querySelector("#cbxDirtyState"),n=e,t=!!JSON.parse(localStorage.getItem("ignoreDirtyState")),n.checked=t,n.addEventListener("change",s),l=JSON.parse(localStorage.getItem("items"))||[],function(){v();let e={labels:["Avg","1","2","3","4","5","6"],datasets:c.map((e=>({label:e,backgroundColor:d[e],data:[0,0,0,0,0,0,0]})))};A=new Chart(document.getElementById("ctxWinRate"),{type:"bar",data:e,options:{scales:{yAxes:[{ticks:{max:50,min:-50,callback:function(e,t,n){return`${("string"==typeof e?0:e)+50}%`}}}]},tooltips:{callbacks:{label:function(e,t){var n=t.datasets[e.datasetIndex].label||"";return n&&(n+=": "),n+(("string"==typeof e.yLabel?0:e.yLabel)+50).toFixed(2)}}},title:{position:"left",display:!0,text:"Winrate"}}}),e={labels:["Avg","1","2","3","4","5","6"],datasets:c.map((e=>({label:e,backgroundColor:d[e],data:[0,0,0,0,0,0,0]})))},C=new Chart(document.getElementById("ctxGames"),{type:"bar",data:e,options:{scales:{yAxes:[{ticks:{min:0}}]},title:{position:"left",display:!0,text:"Games played"}}}),e={labels:new Array(20).fill(""),datasets:c.map((e=>({label:e,borderColor:d[e],fill:!1,data:new Array(20).fill(0)})))},I=new Chart(document.getElementById("ctxProgress1"),{type:"line",data:e,options:{title:{position:"left",display:!0,text:"Skill Rating"}}}),e={labels:new Array(100).fill(""),datasets:c.map((e=>({label:e,borderColor:d[e],fill:!1,data:new Array(100).fill(0)})))},G=new Chart(document.getElementById("ctxProgress2"),{type:"line",data:e,options:{title:{position:"left",display:!0,text:"Skill Rating"},elements:{point:{radius:0}},scales:{xAxes:[{gridLines:{display:!1}}]}}})}(),k(),r(!1),window.dispatchEvent(new Event("updateAll"))})),window.addEventListener("beforeunload",(n=>{if(!t&&e){const e="You may export the latest changes";return n.returnValue=e,e}})),window.addEventListener("updateAll",(()=>{!function(){const e=document.querySelector("select.season"),t=e.value;e.innerHTML="";let n=L().map((e=>e.season));n=[...new Set(n)],n.splice(0,0,"All"),n.forEach((t=>{const n=document.createElement("option");e.appendChild(n),n.innerText="All"==t?t:"S"+t,n.setAttribute("value",t)})),e.value=t||n[n.length-1],-1===e.selectedIndex&&(e.value=n[n.length-1])}(),z(),W(),function(){const e=function(){const e={high:[0,0,0],low:[0,0,0]};return c.forEach(((t,n)=>{const s=b(t);e.high[n]=s.high,e.low[n]=s.low})),e}(),t=function(){const e=x(),t={srGain:[0,0,0],srLoss:[0,0,0],srWin:[0,0,0],high:[0,0,0],low:[0,0,0]};return c.forEach(((n,s)=>{const r=b(n,e);t.srGain[s]=r.srAvg||0,t.srGain[s]=t.srGain[s].toFixed(1),t.srLoss[s]=r.srLoss||0,t.srLoss[s]=t.srLoss[s].toFixed(1),t.srWin[s]=r.srWin||0,t.srWin[s]=t.srWin[s].toFixed(1)})),t}(),n=function(){const e={start:[0,0,0],current:[0,0,0],gain:[0,0,0],wld:[0,0,0],sum:0};return c.forEach(((t,n)=>{const s=b(t);e.start[n]=s.sessionStart,e.current[n]=s.sessionCurrent,e.gain[n]=s.sessionCurrent-s.sessionStart,e.sum+=e.gain[n],e.wld[0]+=s.sessionWin,e.wld[1]+=s.sessionLoss,e.wld[2]+=s.sessionDraw})),e}();document.getElementById("seasonHeader").innerText="Season "+x();const s=[e.high,e.low,null,t.srWin,t.srLoss,null,n.gain];document.querySelectorAll("#infoTable tbody tr").forEach(((e,t)=>{e.querySelectorAll("td").forEach(((e,n)=>{s[t]&&(e.innerText=s[t][n])}))})),document.getElementById("sessionResult").innerHTML=`<b>This Session:</b>&nbsp;&nbsp;${n.wld[0]}W / ${n.wld[1]}L / ${n.wld[2]}D&nbsp;&nbsp;&nbsp;&nbsp;(${n.sum})`}(),D()})),window.updateStats=W,window.updateSeasonStats=()=>{z()},window.addRow=P,window.exportEntries=function(){!function(e,t,n){const s=document.createElement("a"),r=new Blob([e],{type:"text/plain"});s.href=URL.createObjectURL(r),s.download="entries.txt",s.click()}(JSON.stringify(o())),r(!1)},window.importEntries=function(){R.value="",R.click()},window.setProgressChart=e=>{["ctxProgress1","ctxProgress2"].forEach((e=>{document.getElementById(e).style.display="none"}));const t=document.getElementById("progressSelect").value;document.getElementById(t).style.display=""}})();